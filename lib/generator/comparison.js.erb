var <%= name %> = function(patient) {
  <%- restriction_fns = [] -%>
  <%- comparison.restrictions.each do |restriction| -%>
  <%- name = new_fn_name('rest') -%>
  <%- restriction_fns << name -%>
  <%= js_for_restriction(restriction, name) -%>
  <%- end -%>

  <%- data_criteria = doc.data_criteria(comparison.data_criteria_id) -%>
  // <%= data_criteria.title %>
  <%- if data_criteria.property -%>
  var eventsMatchingComparison = [patient.<%= data_criteria.property %>()];
  <%- else -%>
  var eventsMatchingComparison = patient.<%= data_criteria.type %>s().match(dataCriteria["<%= data_criteria.const_name %>"].codes);
  <%- if data_criteria.status -%>
  eventsMatchingComparison = filterByStatus(eventsMatchingComparison, "<%= data_criteria.status %>");
  <%- end -%>
  <%- end -%>
  
  <%- comparison.restrictions.each_with_index do |restriction,i| -%>
  <%- if doc.attribute(restriction.target_id) || restriction.field -%>
    eventsMatchingComparison = <%= restriction_fns[i] %>(patient, eventsMatchingComparison);
  <%- end -%>
  <%- end -%>
  
  <%- if comparison.subset -%>
    eventsMatchingComparison = <%= comparison.subset %>(eventsMatchingComparison);
  <%- end -%>

  <%- comparison.restrictions.each_with_index do |restriction,i| -%>
  <%- if doc.data_criteria(restriction.target_id) -%>
    eventsMatchingComparison = <%= restriction_fns[i] %>(patient, eventsMatchingComparison);
  <%- end -%>
  <%- end -%>

  return eventsMatchingComparison;
}