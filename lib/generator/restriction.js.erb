var <%= name %> = function(patient, events) {
  <%- nested_precondition_fns = [] -%>
  <%- restriction.preconditions.each_with_index do |subcondition, i| -%>
  <%- name = new_fn_name('prcn') -%>
  <%- nested_precondition_fns << name -%>
  <%= js_for_precondition(subcondition, name) -%>
  <%- end -%>
  
  // <%= restriction.type %>
  <%- if restriction.comparison -%>
    <%- name = new_fn_name('comp') -%>
    <%- nested_comparison_fn = name -%>
    <%= js_for_comparison(restriction.comparison, name) %>
  <%- end -%>

  var eventsMatchingComparison = null;
  <%- if doc.attribute(restriction.target_id) -%>
    // <%= restriction.type %> <%= doc.attribute(restriction.target_id).name %>
    eventsMatchingComparison = <%= restriction.type %>(
      attributes["<%= doc.attribute(restriction.target_id).const_name %>"],
      events<%- -%>
      <%- if restriction.range -%>
      <%- -%>, <%= js_for_range(restriction.range) %>
      <%- end -%>
    );
  <%- elsif nested_comparison_fn -%>
    var otherEvents = <%= nested_comparison_fn %>(patient);
    eventsMatchingComparison = <%= restriction.type %>(events, otherEvents<%- -%>
      <%- if restriction.range -%>
      <%- -%>, <%= js_for_range(restriction.range) %>
      <%- end -%>);
  <%- elsif restriction.field -%>
    eventsMatchingComparison = <%= restriction.type %>(events, "<%= restriction.field %>", "<%= restriction.value %>"); 
  <%- elsif restriction.preconditions && restriction.preconditions.length>0 -%>
    eventsMatchingComparison = <%= restriction.preconditions[0].conjunction %>(
    <%- nested_precondition_fns.each_with_index do |fn, i| -%>
      <%= ',' if i>0 %><%= fn %>(patient)
    <%- end -%>
    );
  <%- end -%>
      
  return eventsMatchingComparison;
}