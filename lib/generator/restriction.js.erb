var <%= name %> = function(patient, events) {
  <%- nested_comparison_fns = [] -%>
  <%- if restriction.comparison -%>
    <%- name = new_fn_name('comp') -%>
    <%- nested_comparison_fn = name -%>
    <%= js_for_comparison(restriction.comparison, name) %>
  <%- end -%>

  var eventsMatchingComparison = null;
  <%- if doc.attribute(restriction.target_id) -%>
    // <%= restriction.type %> <%= doc.attribute(restriction.target_id).name %>
    eventsMatchingComparison = <%= restriction.type %>(
      attributes["<%= doc.attribute(restriction.target_id).const_name %>"],
      events<%- -%>
      <%- if restriction.range -%>
      <%- -%>, <%= js_for_range(restriction.range) %>
      <%- end -%>
    );
  <%- else -%>
    var otherEvents = <%= nested_comparison_fn %>(patient);
    eventsMatchingComparison = <%= restriction.type %>(events, otherEvents);
  <%- end -%>
      
  return eventsMatchingComparison;
}